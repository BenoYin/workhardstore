<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客详情 - 知享</title>
    <!-- 外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#64748B',
                        accent: '#10B981',
                        light: '#F1F5F9',
                        dark: '#1E293B',
                        premium: '#8B5CF6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-balance {
                text-wrap: balance;
            }
            .blog-container {
                max-width: 800px;
            }
        }
    </style>
    
    <style>
        /* 文章内容样式 */
        .notion-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem;
        }
        .notion-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.2rem 0 0.8rem;
        }
        .notion-content p {
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        .notion-content img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }
        .notion-content ul, .notion-content ol {
            margin: 1rem 0 1rem 1.5rem;
        }
        .notion-content li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        .notion-content blockquote {
            border-left: 4px solid #e2e8f0;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #64748B;
        }
        
        /* 加载动画 */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #F1F5F9;
            border-bottom-color: #3B82F6;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-dark">
    <!-- 导航栏 -->
    <header id="navbar" class="fixed w-full bg-white/90 backdrop-blur-sm z-50 transition-all duration-300 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-primary flex items-center">
                <i class="fa fa-lightbulb-o mr-2"></i>知享
            </a>
            
            <!-- 桌面端导航 -->
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html#blog" class="text-secondary hover:text-primary transition-colors">博客</a>
                <a href="index.html#tools" class="text-secondary hover:text-primary transition-colors">工具</a>
                <a href="index.html#membership" class="text-secondary hover:text-primary transition-colors">会员</a>
                <a href="#" class="text-secondary hover:text-primary transition-colors">关于</a>
                <button id="authBtn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-all active:scale-95">
                    登录
                </button>
            </nav>
            
            <!-- 移动端菜单按钮 -->
            <button id="menuBtn" class="md:hidden text-secondary text-xl">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        
        <!-- 移动端导航菜单 -->
        <div id="mobileMenu" class="md:hidden hidden bg-white border-t">
            <div class="container mx-auto px-4 py-3 flex flex-col space-y-3">
                <a href="index.html#blog" class="py-2 text-secondary hover:text-primary transition-colors">博客</a>
                <a href="index.html#tools" class="py-2 text-secondary hover:text-primary transition-colors">工具</a>
                <a href="index.html#membership" class="py-2 text-secondary hover:text-primary transition-colors">会员</a>
                <a href="#" class="py-2 text-secondary hover:text-primary transition-colors">关于</a>
                <button id="mobileAuthBtn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-all active:scale-95 w-full">
                    登录
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 pt-28 pb-16">
        <!-- 文章标题区 -->
        <div class="blog-container mx-auto mb-10">
            <div class="flex items-center text-sm text-secondary mb-4">
                <a href="index.html#blog" class="hover:text-primary flex items-center">
                    <i class="fa fa-arrow-left mr-1"></i> 返回博客列表
                </a>
            </div>
            
            <div id="postHeader" class="mb-8">
                <!-- 加载状态 -->
                <div id="headerLoader" class="flex flex-col gap-3">
                    <div class="h-6 bg-light rounded w-1/4 animate-pulse"></div>
                    <div class="h-10 bg-light rounded w-3/4 animate-pulse"></div>
                    <div class="h-6 bg-light rounded w-1/2 animate-pulse"></div>
                </div>
                
                <!-- 文章标题信息将通过JS加载 -->
            </div>
            
            <!-- 文章封面图 -->
            <div id="postCover" class="w-full h-[300px] md:h-[400px] rounded-xl overflow-hidden mb-10 bg-light">
                <img id="coverImage" src="" alt="文章封面" class="w-full h-full object-cover" loading="lazy">
            </div>
            
            <!-- 会员专享提示 -->
            <div id="premiumNotice" class="hidden bg-premium/10 border border-premium/20 rounded-lg p-4 mb-8 flex items-start">
                <i class="fa fa-lock text-premium mt-0.5 mr-3"></i>
                <div>
                    <h4 class="font-medium text-premium">会员专享内容</h4>
                    <p class="text-sm text-secondary mt-1">升级专业版会员即可阅读全文，解锁更多优质内容</p>
                    <button class="mt-3 px-4 py-2 bg-premium text-white rounded-lg text-sm hover:bg-premium/90 transition-all">
                        立即升级
                    </button>
                </div>
            </div>
            
            <!-- 文章内容区 -->
            <div id="postContent" class="notion-content bg-white rounded-xl p-6 md:p-8 shadow-sm">
                <div class="flex justify-center py-10">
                    <div class="loader"></div>
                </div>
                <!-- 文章内容将通过JS加载 -->
            </div>
            
            <!-- 相关文章推荐 -->
            <div class="mt-16">
                <h3 class="text-xl font-semibold mb-6">相关推荐</h3>
                <div id="relatedPosts" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 相关文章将通过JS加载 -->
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa fa-lightbulb-o mr-2"></i>知享
                    </h3>
                    <p class="text-gray-400 text-sm">知识 · 工具 · 成长<br>实用工具与深度内容的结合</p>
                </div>
                
                <div>
                    <h4 class="font-medium mb-4">快速链接</h4>
                    <ul class="space-y-2 text-gray-400 text-sm">
                        <li><a href="#" class="hover:text-white transition-colors">关于我们</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">联系我们</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">隐私政策</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">服务条款</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-medium mb-4">资源</h4>
                    <ul class="space-y-2 text-gray-400 text-sm">
                        <li><a href="#" class="hover:text-white transition-colors">博客</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">工具</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">会员</a></li>
                        <li><a href="#" class="hover:text-white transition-colors">常见问题</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-medium mb-4">订阅更新</h4>
                    <p class="text-gray-400 text-sm mb-3">获取最新工具和文章推送</p>
                    <div class="flex">
                        <input type="email" placeholder="你的邮箱" class="px-3 py-2 bg-gray-800 rounded-l-lg text-sm w-full focus:outline-none focus:ring-1 focus:ring-primary">
                        <button class="bg-primary px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-colors">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500 text-sm">
                <p>© 2023 知享. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <!-- 登录模态框 (复用主页面逻辑) -->
    <div id="authModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modalTitle">登录账号</h3>
                <button id="closeModal" class="text-secondary hover:text-dark">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="your@email.com" required>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="至少6个字符" required>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="remember" class="ml-2 block text-sm text-gray-700">记住我</label>
                    </div>
                    <a href="#" class="text-sm text-accent hover:underline">忘记密码？</a>
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors active:scale-95">
                    登录
                </button>
            </form>
            
            <p class="text-center text-sm text-gray-600 mt-4">
                <span id="modalSwitchText">还没有账号？</span>
                <button id="switchAuthMode" class="text-accent font-medium hover:underline ml-1">注册</button>
            </p>
        </div>
    </div>

    <script>
        // Notion 配置参数
        const NOTION_API_KEY = "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";
        const NOTION_API_VERSION = "2022-06-28";
        
        // 获取URL中的文章ID
        function getPostId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            const postId = getPostId();
            
            if (!postId) {
                showError('未找到文章ID，请返回博客列表');
                return;
            }
            
            // 加载文章详情
            fetchPostDetails(postId);
            
            // 加载相关文章
            fetchRelatedPosts(postId);
            
            // 初始化导航功能
            initNavbar();
            initAuthModal();
        });
        
        // 从Notion获取文章详情
        async function fetchPostDetails(postId) {
            try {
                const response = await fetch(`https://api.notion.com/v1/pages/${postId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${NOTION_API_KEY}`,
                        'Notion-Version': NOTION_API_VERSION,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`获取文章失败: ${response.status}`);
                }
                
                const pageData = await response.json();
                
                // 获取文章内容块
                const blocksResponse = await fetch(`https://api.notion.com/v1/blocks/${postId}/children`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${NOTION_API_KEY}`,
                        'Notion-Version': NOTION_API_VERSION
                    }
                });
                
                if (!blocksResponse.ok) {
                    throw new Error(`获取文章内容失败: ${blocksResponse.status}`);
                }
                
                const blocksData = await blocksResponse.json();
                
                // 渲染文章信息
                renderPostHeader(pageData);
                renderPostContent(blocksData.results);
                
                // 检查是否为会员专享文章
                const isPremium = pageData.properties?.IsPremium?.checkbox || false;
                if (isPremium) {
                    document.getElementById('premiumNotice').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('加载文章失败:', error);
                showError('加载文章失败，请稍后重试');
            }
        }
        
        // 渲染文章标题和元数据
        function renderPostHeader(pageData) {
            const headerContainer = document.getElementById('postHeader');
            const coverContainer = document.getElementById('coverImage');
            
            // 提取文章属性
            const title = pageData.properties?.Title?.title?.[0]?.text?.content || '无标题';
            const date = formatDate(pageData.properties?.Date?.date?.start) || '未知日期';
            const tags = pageData.properties?.Tags?.multi_select || [];
            const coverUrl = pageData.cover?.external?.url || 'https://via.placeholder.com/800x400?text=No+Cover';
            
            // 设置封面图
            coverContainer.src = coverUrl;
            coverContainer.alt = title;
            
            // 渲染标题区
            headerContainer.innerHTML = `
                <div class="flex flex-wrap gap-2 mb-3">
                    ${tags.map(tag => `<span class="px-3 py-1 bg-light text-primary text-xs rounded-full">${tag.name}</span>`).join('')}
                </div>
                <h1 class="text-3xl md:text-4xl font-bold mb-4 text-balance">${title}</h1>
                <div class="flex items-center text-secondary text-sm">
                    <span><i class="fa fa-calendar-o mr-1"></i> ${date}</span>
                </div>
            `;
            
            // 更新页面标题
            document.title = `${title} - 知享`;
        }
        
        // 渲染文章内容
        function renderPostContent(blocks) {
            const contentContainer = document.getElementById('postContent');
            contentContainer.innerHTML = '';
            
            blocks.forEach(block => {
                const blockElement = createBlockElement(block);
                if (blockElement) {
                    contentContainer.appendChild(blockElement);
                }
            });
        }
        
        // 创建单个内容块元素
        function createBlockElement(block) {
            const element = document.createElement('div');
            
            switch (block.type) {
                case 'paragraph':
                    element.classList.add('mb-4');
                    element.innerHTML = `<p>${renderRichText(block.paragraph.rich_text)}</p>`;
                    break;
                    
                case 'heading_1':
                    element.innerHTML = `<h1>${renderRichText(block.heading_1.rich_text)}</h1>`;
                    break;
                    
                case 'heading_2':
                    element.innerHTML = `<h2>${renderRichText(block.heading_2.rich_text)}</h2>`;
                    break;
                    
                case 'heading_3':
                    element.innerHTML = `<h3>${renderRichText(block.heading_3.rich_text)}</h3>`;
                    break;
                    
                case 'bulleted_list_item':
                    element.innerHTML = `<li>${renderRichText(block.bulleted_list_item.rich_text)}</li>`;
                    element.classList.add('list-disc');
                    break;
                    
                case 'numbered_list_item':
                    element.innerHTML = `<li>${renderRichText(block.numbered_list_item.rich_text)}</li>`;
                    element.classList.add('list-decimal');
                    break;
                    
                case 'image':
                    const imageUrl = block.image.external?.url || block.image.file?.url;
                    const caption = block.image.caption.length > 0 ? renderRichText(block.image.caption) : '';
                    element.innerHTML = `
                        <figure>
                            <img src="${imageUrl}" alt="${caption || '图片'}" class="rounded-lg">
                            ${caption ? `<figcaption class="text-sm text-secondary text-center mt-1">${caption}</figcaption>` : ''}
                        </figure>
                    `;
                    break;
                    
                case 'quote':
                    element.innerHTML = `<blockquote>${renderRichText(block.quote.rich_text)}</blockquote>`;
                    break;
                    
                case 'divider':
                    element.innerHTML = '<hr class="my-6 border-gray-200">';
                    break;
                    
                default:
                    // 处理不支持的块类型
                    console.log('不支持的内容块类型:', block.type);
                    return null;
            }
            
            return element;
        }
        
        // 渲染富文本内容
        function renderRichText(richTextArray) {
            if (!richTextArray || richTextArray.length === 0) {
                return '';
            }
            
            return richTextArray.map(text => {
                let content = text.plain_text;
                
                // 处理文本格式
                if (text.annotations.bold) {
                    content = `<strong>${content}</strong>`;
                }
                if (text.annotations.italic) {
                    content = `<em>${content}</em>`;
                }
                if (text.annotations.strikethrough) {
                    content = `<s>${content}</s>`;
                }
                if (text.annotations.underline) {
                    content = `<u>${content}</u>`;
                }
                if (text.annotations.code) {
                    content = `<code class="bg-light px-1 py-0.5 rounded text-sm">${content}</code>`;
                }
                
                // 处理链接
                if (text.href) {
                    content = `<a href="${text.href}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${content}</a>`;
                }
                
                return content;
            }).join('');
        }
        
        // 获取相关文章
        async function fetchRelatedPosts(currentPostId) {
            try {
                // 这里简化处理，实际应该根据标签获取相关文章
                const response = await fetch(`https://api.notion.com/v1/databases/2419a13c048a80c7ba63000c42b77548/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_API_KEY}`,
                        'Notion-Version': NOTION_API_VERSION,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_size: 2,
                        filter: {
                            property: "id",
                            text: {
                                does_not_equal: currentPostId
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`获取相关文章失败: ${response.status}`);
                }
                
                const data = await response.json();
                renderRelatedPosts(data.results);
                
            } catch (error) {
                console.error('加载相关文章失败:', error);
                document.getElementById('relatedPosts').innerHTML = '';
            }
        }
        
        // 渲染相关文章
        function renderRelatedPosts(posts) {
            const container = document.getElementById('relatedPosts');
            
            if (posts.length === 0) {
                container.innerHTML = '<p class="text-secondary">暂无相关文章</p>';
                return;
            }
            
            posts.forEach(post => {
                const title = post.properties?.Title?.title?.[0]?.text?.content || "无标题";
                const cover = post.properties?.Cover?.files?.[0]?.external?.url || "https://via.placeholder.com/300x200?text=No+Image";
                const date = formatDate(post.properties?.Date?.date?.start) || "";
                
                const card = document.createElement('a');
                card.href = `blog-detail.html?id=${post.id}`;
                card.className = "bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow";
                
                card.innerHTML = `
                    <div class="h-40 overflow-hidden">
                        <img src="${cover}" alt="${title}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
                    </div>
                    <div class="p-4">
                        <div class="text-secondary text-sm mb-2">${date}</div>
                        <h4 class="font-medium line-clamp-2">${title}</h4>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // 显示错误信息
        function showError(message) {
            const contentContainer = document.getElementById('postContent');
            contentContainer.innerHTML = `
                <div class="text-center py-10 text-secondary">
                    <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                    <p>${message}</p>
                </div>
            `;
            
            // 隐藏标题加载状态
            document.getElementById('headerLoader').style.display = 'none';
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // 初始化导航栏
        function initNavbar() {
            const navbar = document.getElementById('navbar');
            const menuBtn = document.getElementById('menuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            // 滚动时改变导航栏样式
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    navbar.classList.add('shadow');
                    navbar.classList.remove('bg-white/90');
                    navbar.classList.add('bg-white');
                } else {
                    navbar.classList.remove('shadow');
                    navbar.classList.add('bg-white/90');
                    navbar.classList.remove('bg-white');
                }
            });
            
            // 移动端菜单切换
            menuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                const icon = menuBtn.querySelector('i');
                if (mobileMenu.classList.contains('hidden')) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                } else {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                }
            });
        }
        
        // 初始化登录模态框
        function initAuthModal() {
            const authBtn = document.getElementById('authBtn');
            const mobileAuthBtn = document.getElementById('mobileAuthBtn');
            const authModal = document.getElementById('authModal');
            const closeModal = document.getElementById('closeModal');
            const switchAuthMode = document.getElementById('switchAuthMode');
            const modalTitle = document.getElementById('modalTitle');
            const modalSwitchText = document.getElementById('modalSwitchText');
            
            // 打开模态框
            function openModal() {
                authModal.classList.remove('hidden');
                authModal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
            
            // 关闭模态框
            function closeModalFunc() {
                authModal.classList.add('hidden');
                authModal.classList.remove('flex');
                document.body.style.overflow = '';
            }
            
            // 切换登录/注册模式
            let isLoginMode = true;
            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                if (isLoginMode) {
                    modalTitle.textContent = '登录账号';
                    modalSwitchText.textContent = '还没有账号？';
                    switchAuthMode.textContent = '注册';
                } else {
                    modalTitle.textContent = '创建账号';
                    modalSwitchText.textContent = '已有账号？';
                    switchAuthMode.textContent = '登录';
                }
            }
            
            // 事件监听
            authBtn.addEventListener('click', openModal);
            mobileAuthBtn.addEventListener('click', openModal);
            closeModal.addEventListener('click', closeModalFunc);
            switchAuthMode.addEventListener('click', toggleAuthMode);
            
            // 点击模态框外部关闭
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) {
                    closeModalFunc();
                }
            });
            
            // 表单提交处理
            document.getElementById('authForm').addEventListener('submit', (e) => {
                e.preventDefault();
                // 这里应该有登录/注册逻辑，与主页面保持一致
                alert(isLoginMode ? '登录功能待实现' : '注册功能待实现');
                closeModalFunc();
            });
        }
    </script>
</body>
</html>
